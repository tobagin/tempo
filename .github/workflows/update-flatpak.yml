name: Update Flathub on Tag

on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v1.2.3, etc.
  workflow_dispatch:

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version info
      id: version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        COMMIT_HASH=$(git rev-parse $TAG_NAME)
        VERSION=${TAG_NAME#v}
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "📦 Processing release: $TAG_NAME"
        echo "🔍 Commit hash: $COMMIT_HASH"
        echo "📈 Version: $VERSION"

    - name: Check manifest exists
      id: check
      run: |
        MANIFEST_FILE="packaging/io.github.tobagin.tempo.yml"
        
        if [[ ! -f "$MANIFEST_FILE" ]]; then
          echo "❌ Manifest file not found: $MANIFEST_FILE"
          exit 1
        fi
        
        echo "✅ Local manifest found: $MANIFEST_FILE"
        echo "📋 Current manifest tag and commit:"
        grep -A 2 "tag:" "$MANIFEST_FILE" || echo "Tag not found in expected format"
        
        echo "manifest_ready=true" >> $GITHUB_OUTPUT

    - name: Create Flathub PR
      if: steps.check.outputs.manifest_ready == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.FLATHUB_TOKEN }}
      run: |
        FLATHUB_REPO="flathub/io.github.tobagin.tempo"
        
        echo "🔄 Cloning Flathub repository..."
        git clone https://x-access-token:$GITHUB_TOKEN@github.com/$FLATHUB_REPO.git flathub-repo
        cd flathub-repo
        
        git config user.email "action@github.com"
        git config user.name "GitHub Action (Tempo Updates)"
        
        # Copy the manifest and update it with correct tag and commit
        cp ../packaging/io.github.tobagin.tempo.yml ./io.github.tobagin.tempo.yml
        
        # Update the manifest with the correct tag and commit hash (only for tempo module)
        sed -i '/- name: tempo/,/^  - name:/{s/tag: v.*/tag: ${{ steps.version.outputs.tag_name }}/}' io.github.tobagin.tempo.yml
        sed -i '/- name: tempo/,/^  - name:/{s/commit: .*/commit: ${{ steps.version.outputs.commit_hash }}/}' io.github.tobagin.tempo.yml
        
        echo "📋 Updated manifest with:"
        echo "  Tag: ${{ steps.version.outputs.tag_name }}"
        echo "  Commit: ${{ steps.version.outputs.commit_hash }}"
        
        git add io.github.tobagin.tempo.yml
        git commit -m "Update to ${{ steps.version.outputs.tag_name }}

        🚀 **New Release: ${{ steps.version.outputs.tag_name }}**
        
        **Changes:**
        - Updated tag from previous version to ${{ steps.version.outputs.tag_name }}
        - Updated commit hash to ${{ steps.version.outputs.commit_hash }}
        - Automated update from upstream repository
        
        **Source:** https://github.com/tobagin/tempo/releases/tag/${{ steps.version.outputs.tag_name }}
        
        ---
        *This update was automatically created by GitHub Actions*"
        
        # Create a temporary branch for the PR (required by GitHub)
        BRANCH_NAME="update-${{ steps.version.outputs.tag_name }}"
        
        # Delete existing branch if it exists
        git push https://x-access-token:$GITHUB_TOKEN@github.com/$FLATHUB_REPO.git --delete "$BRANCH_NAME" 2>/dev/null || true
        
        git checkout -b "$BRANCH_NAME"
        git push https://x-access-token:$GITHUB_TOKEN@github.com/$FLATHUB_REPO.git "$BRANCH_NAME"
        
        # Create PR using GitHub API
        PR_BODY="🚀 **Automated update to ${{ steps.version.outputs.tag_name }}**

        This PR updates the Flatpak manifest with the latest release from the upstream repository.

        **Changes:**
        - **Tag:** \`${{ steps.version.outputs.tag_name }}\`
        - **Commit:** \`${{ steps.version.outputs.commit_hash }}\`
        - **Release:** https://github.com/tobagin/tempo/releases/tag/${{ steps.version.outputs.tag_name }}

        **Automated Checks:**
        - ✅ Manifest syntax validated
        - ✅ Commit hash verified
        - ✅ Tag references confirmed

        ---
        
        **Test Build:**
        The Flathub CI will automatically build and test this update once the PR is created.

        **Merge Instructions:**
        If the test build passes, this PR can be safely merged to publish the update to Flathub.

        ---
        *🤖 This PR was automatically created by [GitHub Actions](https://github.com/tobagin/tempo/actions)*"
        
        # Create JSON payload for API call
        PR_JSON=$(jq -n \
          --arg title "📦 Update Tempo to ${{ steps.version.outputs.tag_name }}" \
          --arg head "$BRANCH_NAME" \
          --arg base "master" \
          --arg body "$PR_BODY" \
          '{title: $title, head: $head, base: $base, body: $body}')
        
        echo "🔄 Creating PR via GitHub API..."
        API_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          "https://api.github.com/repos/$FLATHUB_REPO/pulls" \
          -d "$PR_JSON")
        
        # Extract PR URL from response
        PR_URL=$(echo "$API_RESPONSE" | jq -r '.html_url // empty')
        
        if [[ -n "$PR_URL" && "$PR_URL" != "null" ]]; then
          echo "✅ Created PR: $PR_URL"
        else
          echo "⚠️ PR creation may have failed. API Response:"
          echo "$API_RESPONSE" | jq '.'
          echo "📋 Manual PR can be created at: https://github.com/$FLATHUB_REPO/pull/new/$BRANCH_NAME"
        fi

    - name: Summary
      if: always()
      run: |
        echo "## 📋 Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${{ steps.version.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ steps.version.outputs.commit_hash }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check.outputs.manifest_ready }}" == "true" ]]; then
          echo "✅ **Manifest Ready:** Local Flatpak manifest found and validated" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Flathub PR Created:** Pull request submitted to Flathub repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Manifest Missing:** Local manifest not found or invalid" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Monitor the Flathub PR for CI build status" >> $GITHUB_STEP_SUMMARY
        echo "2. Once CI passes, approve and merge the PR" >> $GITHUB_STEP_SUMMARY
        echo "3. The new version will be published to Flathub automatically" >> $GITHUB_STEP_SUMMARY